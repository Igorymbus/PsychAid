{% load static %}
<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Подсистема школьного психолога{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{% static 'css/app.css' %}" rel="stylesheet">
</head>
<body
    class="app-body"
    {% if user.is_authenticated %}
    data-role-name="{{ user_profile.role_name|default:'' }}"
    data-request-create-url="{% if user_profile.role_name == 'student' %}{% url 'consultations:my_request_create' %}{% else %}{% url 'consultations:request_create' %}{% endif %}"
    {% endif %}
>
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <div class="app-layout">
        <aside class="app-sidebar">
            <div class="app-sidebar-header">
                <div class="d-flex align-items-center gap-2">
                    <div class="app-sidebar-logo">
                        <i class="bi bi-heart-pulse"></i>
                    </div>
                    <div class="app-sidebar-title">
                        Школьный психолог
                    </div>
                </div>
                <button class="app-theme-toggle" id="themeToggle" type="button">
                    <i class="bi bi-moon-stars" id="themeIcon"></i>
                    <span id="themeLabel">Тёмная</span>
                </button>
            </div>

            {% if user.is_authenticated %}
            <nav class="app-sidebar-nav">
                {% if user_profile.role_name == 'student' %}
                <a href="{% url 'consultations:student_dashboard' %}"
                   data-shortcut="Alt+Shift+1"
                   class="app-sidebar-link {% if request.resolver_match.url_name == 'student_dashboard' %}active{% endif %}">
                    <i class="bi bi-house-door"></i>
                    <span>Личный кабинет</span>
                </a>
                <a href="{% url 'consultations:my_request_list' %}"
                   data-shortcut="Alt+Shift+2"
                   class="app-sidebar-link {% if request.resolver_match.url_name == 'my_request_list' or request.resolver_match.url_name == 'my_request_detail' or request.resolver_match.url_name == 'my_request_create' %}active{% endif %}">
                    <i class="bi bi-chat-dots"></i>
                    <span>Мои обращения</span>
                </a>
                <a href="{% url 'consultations:my_request_create' %}" data-shortcut-action="create-request" class="app-sidebar-link">
                    <i class="bi bi-plus-circle"></i>
                    <span>Подать обращение</span>
                </a>
                <a href="{% url 'students:my_profile' %}"
                   data-shortcut="Alt+Shift+3"
                   class="app-sidebar-link {% if request.resolver_match.url_name == 'my_profile' %}active{% endif %}">
                    <i class="bi bi-person-vcard"></i>
                    <span>Мой профиль</span>
                </a>
                <a href="{% url 'consultations:student_chat' %}"
                   data-shortcut="Alt+Shift+4"
                   class="app-sidebar-link {% if request.resolver_match.url_name == 'student_chat' %}active{% endif %}">
                    <i class="bi bi-chat-square-text"></i>
                    <span>Чат с психологом</span>
                </a>
                {% else %}
                <a href="{% url 'students:student_list' %}"
                   data-shortcut="Alt+Shift+1"
                   class="app-sidebar-link {% if request.resolver_match.namespace == 'students' and request.resolver_match.url_name != 'my_profile' %}active{% endif %}">
                    <i class="bi bi-people"></i>
                    <span>Учащиеся</span>
                </a>
                <a href="{% url 'consultations:request_list' %}"
                   data-shortcut="Alt+Shift+2"
                   class="app-sidebar-link {% if request.resolver_match.url_name|default:''|slice:':7' == 'request' and request.resolver_match.url_name != 'my_request_list' and request.resolver_match.url_name != 'my_request_detail' and request.resolver_match.url_name != 'my_request_create' %}active{% endif %}">
                    <i class="bi bi-chat-dots"></i>
                    <span>Обращения</span>
                </a>
                <a href="{% url 'consultations:consultation_list' %}"
                   data-shortcut="Alt+Shift+3"
                   class="app-sidebar-link {% if request.resolver_match.url_name|default:''|slice:':12' == 'consultation' %}active{% endif %}">
                    <i class="bi bi-journal-text"></i>
                    <span>Консультации</span>
                </a>
                <a href="{% url 'consultations:report' %}"
                   data-shortcut="Alt+Shift+4"
                   class="app-sidebar-link {% if request.resolver_match.url_name == 'report' %}active{% endif %}">
                    <i class="bi bi-graph-up"></i>
                    <span>Отчёты</span>
                </a>
                <a href="{% url 'consultations:psychologist_chat_list' %}"
                   data-shortcut="Alt+Shift+5"
                   class="app-sidebar-link {% if request.resolver_match.url_name == 'psychologist_chat_list' or request.resolver_match.url_name == 'psychologist_chat_detail' %}active{% endif %}">
                    <i class="bi bi-chat-square-dots"></i>
                    <span>Чаты учащихся</span>
                    {% if unread_student_chat_messages %}
                    <span class="badge bg-danger ms-auto chat-unread-badge">{{ unread_student_chat_messages }}</span>
                    {% endif %}
                </a>
                {% if user.is_superuser or user_profile and user_profile.is_administrator %}
                <a href="{% url 'users:user_list' %}"
                   data-shortcut="Alt+Shift+6"
                   class="app-sidebar-link {% if request.resolver_match.namespace == 'users' %}active{% endif %}">
                    <i class="bi bi-person-gear"></i>
                    <span>Пользователи</span>
                </a>
                <a href="{% url 'consultations:database_maintenance' %}"
                   class="app-sidebar-link {% if request.resolver_match.url_name == 'database_maintenance' %}active{% endif %}">
                    <i class="bi bi-database-gear"></i>
                    <span>Бэкап БД</span>
                </a>
                {% endif %}

                <div class="mt-3 small text-uppercase text-muted fw-semibold">Основные действия</div>
                {% if user.is_superuser or user_profile and user_profile.is_administrator %}
                <a href="{% url 'students:student_create' %}" data-shortcut-action="create-student" class="app-sidebar-link">
                    <i class="bi bi-person-plus"></i>
                    <span>Добавить учащегося</span>
                </a>
                <a href="{% url 'consultations:request_create' %}" data-shortcut-action="create-request" class="app-sidebar-link">
                    <i class="bi bi-plus-circle"></i>
                    <span>Новое обращение</span>
                </a>
                {% endif %}
            </nav>

            <div class="app-sidebar-footer">
                <div class="app-sidebar-user">
                    <span>{{ user.get_full_name|default:user.username }}</span>
                    <span class="text-muted small">{% if user_profile %}{{ user_profile.get_role_display }}{% else %}{{ user.role_name|default:"—" }}{% endif %}</span>
                </div>
                <a href="{% url 'users:logout' %}" data-shortcut-action="logout" class="btn btn-sm btn-outline-light" title="Выйти">
                    <i class="bi bi-box-arrow-right"></i>
                </a>
            </div>
            {% endif %}
            {% endif %}
        </aside>

        <div class="app-main">
            <header class="app-topbar">
                <button class="app-burger" id="sidebarToggle" type="button">
                    <i class="bi bi-list"></i>
                </button>
                <div class="app-topbar-title">
                    {% block topbar_title %}{% endblock %}
                </div>
                {% if user.is_authenticated %}
                <div class="app-topbar-user d-flex align-items-center gap-2">
                    <button
                        class="btn btn-sm btn-outline-primary"
                        type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#hotkeysModal"
                        title="Горячие клавиши (Alt+Shift+H)"
                    >
                        <i class="bi bi-keyboard"></i> Клавиши
                    </button>
                    <span class="text-muted small">{{ user.get_full_name|default:user.username }}</span>
                    <a href="{% url 'users:logout' %}" data-shortcut-action="logout" class="btn btn-sm btn-outline-secondary" title="Выйти">
                        <i class="bi bi-box-arrow-right"></i> Выход
                    </a>
                </div>
                {% endif %}
            </header>

            <main class="app-content my-3 page-shell">
                {% if messages %}
                {% for msg in messages %}
                <div class="alert alert-{% if msg.tags == 'error' %}danger{% else %}{{ msg.tags }}{% endif %} alert-dismissible fade show" role="alert">
                    {{ msg }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
                {% endif %}

                {% block content %}{% endblock %}
            </main>

            <footer class="py-2 text-center text-muted small">
                Подсистема учёта психологических консультаций
            </footer>
        </div>
    </div>

    {% if user.is_authenticated %}
    <div class="modal fade hotkeys-modal" id="hotkeysModal" tabindex="-1" aria-labelledby="hotkeysModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content card-soft">
                <div class="modal-header">
                    <h5 class="modal-title hotkeys-modal__title" id="hotkeysModalLabel"><i class="bi bi-keyboard"></i> Горячие клавиши</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <div class="hotkeys-list">
                        <div class="hotkeys-row"><span class="hotkeys-label">Сменить тему</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>T</kbd></span></div>
                        <div class="hotkeys-row"><span class="hotkeys-label">Подать / создать обращение</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>N</kbd></span></div>
                        <div class="hotkeys-row"><span class="hotkeys-label">Справка по клавишам</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>H</kbd></span></div>
                    </div>
                    <hr>
                    <div class="small text-muted mb-2">Навигация по разделам:</div>
                    <div class="hotkeys-list">
                        {% if user_profile.role_name == 'student' %}
                        <div class="hotkeys-row"><span class="hotkeys-label">Личный кабинет</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>1</kbd></span></div>
                        <div class="hotkeys-row"><span class="hotkeys-label">Мои обращения</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>2</kbd></span></div>
                        <div class="hotkeys-row"><span class="hotkeys-label">Мой профиль</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>3</kbd></span></div>
                        <div class="hotkeys-row"><span class="hotkeys-label">Чат с психологом</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>4</kbd></span></div>
                        {% else %}
                        <div class="hotkeys-row"><span class="hotkeys-label">Учащиеся</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>1</kbd></span></div>
                        <div class="hotkeys-row"><span class="hotkeys-label">Обращения</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>2</kbd></span></div>
                        <div class="hotkeys-row"><span class="hotkeys-label">Консультации</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>3</kbd></span></div>
                        <div class="hotkeys-row"><span class="hotkeys-label">Отчёты</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>4</kbd></span></div>
                        <div class="hotkeys-row"><span class="hotkeys-label">Чаты учащихся</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>5</kbd></span></div>
                        {% if user_profile.role_name == 'admin' or user.is_superuser %}
                        <div class="hotkeys-row"><span class="hotkeys-label">Пользователи</span><span class="hotkeys-combo"><kbd>Alt</kbd><span class="hotkeys-sep">+</span><kbd>Shift</kbd><span class="hotkeys-sep">+</span><kbd>6</kbd></span></div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function () {
            const root = document.documentElement;
            const saved = localStorage.getItem('app-theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initial = saved || (prefersDark ? 'dark' : 'light');
            root.setAttribute('data-theme', initial);

            function syncThemeControls(mode) {
                const icon = document.getElementById('themeIcon');
                const label = document.getElementById('themeLabel');
                if (!icon || !label) return;
                if (mode === 'dark') {
                    icon.className = 'bi bi-brightness-high';
                    label.textContent = 'Светлая';
                } else {
                    icon.className = 'bi bi-moon-stars';
                    label.textContent = 'Тёмная';
                }
            }

            syncThemeControls(initial);

            document.addEventListener('DOMContentLoaded', function () {
                const toggle = document.getElementById('themeToggle');
                const burger = document.getElementById('sidebarToggle');
                const backdrop = document.getElementById('sidebarBackdrop');
                const body = document.body;
                const hotkeysModalEl = document.getElementById('hotkeysModal');
                const hotkeysModal = hotkeysModalEl ? new bootstrap.Modal(hotkeysModalEl) : null;

                if (toggle) {
                    toggle.addEventListener('click', function () {
                        const current = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
                        const next = current === 'dark' ? 'light' : 'dark';
                        root.setAttribute('data-theme', next);
                        localStorage.setItem('app-theme', next);
                        syncThemeControls(next);
                    });
                }

                function toggleSidebar() {
                    body.classList.toggle('sidebar-open');
                }

                if (burger) {
                    burger.addEventListener('click', toggleSidebar);
                }
                if (backdrop) {
                    backdrop.addEventListener('click', toggleSidebar);
                }

                const roleName = (body.dataset.roleName || '').toLowerCase();
                const requestCreateUrl = body.dataset.requestCreateUrl || '';

                function navigateByShortcut(digit) {
                    const selector = `.app-sidebar-link[data-shortcut="Alt+Shift+${digit}"]`;
                    const link = document.querySelector(selector);
                    if (link && link.getAttribute('href')) {
                        window.location.href = link.getAttribute('href');
                    }
                }

                function openRequestCreate() {
                    if (requestCreateUrl) {
                        window.location.href = requestCreateUrl;
                    }
                }

                document.addEventListener('keydown', function (e) {
                    if (!(e.altKey && e.shiftKey)) return;
                    const code = e.code;

                    if (code === 'KeyT') {
                        e.preventDefault();
                        if (toggle) toggle.click();
                        return;
                    }
                    if (code === 'KeyH') {
                        e.preventDefault();
                        if (hotkeysModal) hotkeysModal.show();
                        return;
                    }
                    if (code === 'KeyN') {
                        e.preventDefault();
                        openRequestCreate();
                        return;
                    }
                    const digitMap = {
                        Digit1: '1',
                        Digit2: '2',
                        Digit3: '3',
                        Digit4: '4',
                        Digit5: '5',
                        Digit6: '6',
                    };
                    const digit = digitMap[code];
                    if (digit) {
                        e.preventDefault();
                        navigateByShortcut(digit);
                    }
                });
            });
        })();
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>

{% extends 'base.html' %}
{% block title %}Обращения{% endblock %}
{% block content %}
<h2><i class="bi bi-chat-dots"></i> Обращения за консультацией</h2>

<form class="row g-2 mb-4" method="get">
    <div class="col-md-4"><input type="text" name="q" class="form-control" placeholder="Поиск по ФИО учащегося" value="{{ search_q }}"></div>
    <div class="col-auto"><button type="submit" class="btn btn-outline-primary">Найти</button></div>
    {% if user.is_superuser or user_profile.is_administrator %}
    <div class="col-auto"><a href="{% url 'consultations:request_create' %}" class="btn btn-primary">Новое обращение</a></div>
    {% endif %}
</form>

<div class="mb-4">
    <h5 class="text-secondary"><i class="bi bi-circle-fill text-secondary"></i> Новые</h5>
    <table class="table table-hover table-sm request-status-table">
        <colgroup>
            <col class="col-student">
            <col class="col-date">
            <col class="col-source">
            <col class="col-actions">
        </colgroup>
        <thead><tr><th>Учащийся</th><th>Дата</th><th>Источник</th><th>Действия</th></tr></thead>
        <tbody>
            {% for r in requests_new %}
            <tr>
                <td><a href="{% url 'students:student_detail' r.student_id %}">{{ r.student.full_name }}</a></td>
                <td>{{ r.created_at|date:"d.m.Y" }}</td>
                <td>{{ r.get_source_display }}</td>
                <td>
                    <a href="{% url 'consultations:request_detail' r.pk %}" class="btn btn-sm btn-outline-secondary">Открыть</a>
                    {% if user.role_name == 'psychologist' %}
                    <a href="{% url 'consultations:consultation_create' %}?request={{ r.pk }}" class="btn btn-sm btn-outline-primary">Зарегистрировать консультацию</a>
                    {% endif %}
                    {% if user.role_name == 'admin' %}
                    <a href="{% url 'consultations:request_delete' r.pk %}" class="btn btn-sm btn-outline-danger">Удалить</a>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-muted">Нет новых обращений.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mb-4">
    <h5 class="text-primary"><i class="bi bi-circle-fill text-info"></i> В работе</h5>
    <table class="table table-hover table-sm request-status-table">
        <colgroup>
            <col class="col-student">
            <col class="col-date">
            <col class="col-source">
            <col class="col-actions">
        </colgroup>
        <thead><tr><th>Учащийся</th><th>Дата</th><th>Источник</th><th>Действия</th></tr></thead>
        <tbody>
            {% for r in requests_in_progress %}
            <tr>
                <td><a href="{% url 'students:student_detail' r.student_id %}">{{ r.student.full_name }}</a></td>
                <td>{{ r.created_at|date:"d.m.Y" }}</td>
                <td>{{ r.get_source_display }}</td>
                <td>
                    <a href="{% url 'consultations:request_detail' r.pk %}" class="btn btn-sm btn-outline-secondary">Открыть</a>
                    {% if user.role_name == 'admin' %}
                    <a href="{% url 'consultations:request_delete' r.pk %}" class="btn btn-sm btn-outline-danger">Удалить</a>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-muted">Нет обращений в работе.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mb-4">
    <h5 class="text-success"><i class="bi bi-circle-fill text-success"></i> Завершённые</h5>
    <table class="table table-hover table-sm request-status-table">
        <colgroup>
            <col class="col-student">
            <col class="col-date">
            <col class="col-source">
            <col class="col-actions">
        </colgroup>
        <thead><tr><th>Учащийся</th><th>Дата</th><th>Источник</th><th>Действия</th></tr></thead>
        <tbody>
            {% for r in requests_completed %}
            <tr>
                <td><a href="{% url 'students:student_detail' r.student_id %}">{{ r.student.full_name }}</a></td>
                <td>{{ r.created_at|date:"d.m.Y" }}</td>
                <td>{{ r.get_source_display }}</td>
                <td>
                    <a href="{% url 'consultations:request_detail' r.pk %}" class="btn btn-sm btn-outline-secondary">Открыть</a>
                    {% if user.role_name == 'admin' %}
                    <a href="{% url 'consultations:request_delete' r.pk %}" class="btn btn-sm btn-outline-danger">Удалить</a>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-muted">Нет завершённых обращений.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mb-4">
    <h5 class="text-warning"><i class="bi bi-circle-fill text-warning"></i> Отменённые</h5>
    <table class="table table-hover table-sm request-status-table">
        <colgroup>
            <col class="col-student">
            <col class="col-date">
            <col class="col-source">
            <col class="col-actions">
        </colgroup>
        <thead><tr><th>Учащийся</th><th>Дата</th><th>Источник</th><th>Действия</th></tr></thead>
        <tbody>
            {% for r in requests_cancelled %}
            <tr>
                <td><a href="{% url 'students:student_detail' r.student_id %}">{{ r.student.full_name }}</a></td>
                <td>{{ r.created_at|date:"d.m.Y" }}</td>
                <td>{{ r.get_source_display }}</td>
                <td>
                    <a href="{% url 'consultations:request_detail' r.pk %}" class="btn btn-sm btn-outline-secondary">Открыть</a>
                    {% if user.role_name == 'admin' %}
                    <a href="{% url 'consultations:request_delete' r.pk %}" class="btn btn-sm btn-outline-danger">Удалить</a>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-muted">Нет отменённых обращений.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

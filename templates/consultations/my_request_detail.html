{% extends 'base.html' %}
{% load tz %}
{% block title %}Обращение от {{ request_obj.created_at|date:"d.m.Y" }}{% endblock %}
{% block content %}
<h2><i class="bi bi-chat-dots"></i> Обращение от {{ request_obj.created_at|date:"d.m.Y" }}</h2>

{% if not has_profile %}
<div class="alert alert-warning">Ваш аккаунт не привязан к карточке учащегося.</div>
{% else %}
<dl class="row">
    <dt class="col-sm-2">Дата обращения</dt>
    <dd class="col-sm-10">{{ request_obj.created_at|timezone:"Europe/Moscow"|date:"d.m.Y H:i" }}</dd>
    <dt class="col-sm-2">Статус</dt>
    <dd class="col-sm-10"><span class="badge bg-{% if request_obj.status.name == 'new' %}secondary{% elif request_obj.status.name == 'in_progress' %}info{% elif request_obj.status.name == 'cancelled' %}warning{% else %}success{% endif %}">{{ request_obj.status_display }}</span></dd>
    <dt class="col-sm-2">Источник</dt>
    <dd class="col-sm-10">{{ request_obj.get_source_display }}</dd>
</dl>

<h5 class="mt-4">Заметка к обращению</h5>
{% if request_notes %}
<ul class="list-group mb-3">
    {% for n in request_notes %}
    <li class="list-group-item">
        <div class="small text-muted mb-1">{{ n.created_at|timezone:"Europe/Moscow"|date:"d.m.Y H:i" }}</div>
        <div style="white-space: pre-wrap;">{{ n.text }}</div>
    </li>
    {% endfor %}
</ul>
{% else %}
<p class="text-muted">Заметка не добавлена.</p>
{% endif %}

<h5>Консультации по этому обращению</h5>
{% if request_obj.consultations.all %}
<ul class="list-group">
    {% for c in request_obj.consultations.all %}
    <li class="list-group-item">{{ c.date|date:"d.m.Y" }}{% if c.time_display %} {{ c.time_display }}{% else %} —{% endif %} — {{ c.form_display }}</li>
    {% endfor %}
</ul>
{% else %}
<p class="text-muted">Пока нет запланированных или проведённых консультаций. Психолог свяжется с вами после принятия обращения в работу.</p>
{% endif %}

<p class="mt-3">
    <a href="{% url 'consultations:my_request_list' %}" class="btn btn-outline-secondary">← К списку обращений</a>
    <a href="{% url 'consultations:student_dashboard' %}" class="btn btn-outline-primary">В личный кабинет</a>
    {% if request_obj.status.name != 'completed' and request_obj.status.name != 'cancelled' %}
    <form action="{% url 'consultations:my_request_cancel' request_obj.pk %}" method="post" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning"><i class="bi bi-x-circle"></i> Отменить обращение</button>
    </form>
    {% endif %}
</p>
{% endif %}
{% endblock %}

